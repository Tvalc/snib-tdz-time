// --- Coop walk left frames ---
const coopWalkLeftUrls = [
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Walk_L_1_1753895522380.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Walk_L_2_1753895538366.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Walk_L_1_1753895522380.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Walk_L_3_1753895550338.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Walk_L_1_1753895522380.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Walk_L_2_1753895538366.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Walk_L_6_1753895595755.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Walk_L_7_1753895618223.png"
];

// --- Coop jump frames ---
const coopJumpUrls = [
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Jump_Fixed_1754188525088.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Jump_Punch_1754021127728.png"
];

// --- Coop attack frames ---
const coopAttackUrls = [
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Crouch_3_1754021059629.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Crouch_4_1754021076784.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Crouch_1_1754021015142.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Crouch_4_1754021076784.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Crouch_5_1754021239410.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coop_Punch_2_1754021388739.png"
];

// --- DoomShroom walk and heal frames ---
const doomShroomWalkUrls = [
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/DoomShroom_Walk_1_1754071862306.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/DoomShroom_Walk_2_1754071938939.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/DoomShroom_Walk_3_1754071948607.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/DoomShroom_Walk_4_1754071964855.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/DoomShroom_Walk_5_1754071993560.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/DoomShroom_Walk_6_1754072004789.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/DoomShroom_Walk_7_1754072016048.png"
];
const doomShroomHealUrl = "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/DoomShroom_Attack_3_1754074101633.png";

// --- Side-scrolling background images for each wave ---
const sideScrollerBGUrls = [
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/SS_BG_1_1754341198162.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/CSS_BG_2_1754333956343.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/SS_BG_3_1754341662642.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/SS_BG_4_1754334214881.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/SS_BG_5_v2_1754342226393.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/SS_BG_6_1754334666247.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/SS_BG_7_1754334962821.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/SS_BG_8_1754341329340.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/SS_BG_9_1754343416335.png",
  "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/SS_BG_10_1754343518706.png"
];

const coinboyWalkFramesSrc = [
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coin_boy_1_1754116562035.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coin_boy_2_1754116604685.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coin_boy_3_1754116819604.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coin_boy_4_1754116741490.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coin_boy_5_1754116834512.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coin_boy_6_1754116846387.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coin_boy_7_1754116945785.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coin_boy_8_1754116965533.png",
    "https://dcnmwoxzefwqmvvkpqap.supabase.co/storage/v1/object/public/sprite-studio-exports/0f84fe06-5c42-40c3-b563-1a28d18f37cc/library/Coin_boy_9_1754116983128.png"
];

const coinboyProceduralFallback = () => {
    // Return a canvas element with a shiny coinboy cartoon
    const { COINBOY_WIDTH, COINBOY_HEIGHT } = window.constants;
    const c = document.createElement('canvas');
    c.width = COINBOY_WIDTH;
    c.height = COINBOY_HEIGHT;
    const ctx = c.getContext('2d');
    // Gold coin with eyes/limbs
    ctx.save();
    ctx.translate(COINBOY_WIDTH/2, COINBOY_HEIGHT/2);
    // Body
    const grad = ctx.createRadialGradient(0,-6,8,0,0,COINBOY_WIDTH/2);
    grad.addColorStop(0, 'hsl(50 100% 80%)');
    grad.addColorStop(0.45, 'hsl(46 93% 70%)');
    grad.addColorStop(1, 'hsl(42 70% 35%)');
    ctx.beginPath();
    ctx.arc(0,0,COINBOY_WIDTH/2-6,0,2*Math.PI);
    ctx.closePath();
    ctx.fillStyle = grad;
    ctx.shadowColor = 'gold';
    ctx.shadowBlur = 8;
    ctx.fill();
    ctx.shadowBlur = 0;
    // Face
    ctx.beginPath();
    ctx.arc(-8, -7, 4, 0, 2*Math.PI);
    ctx.arc(8, -7, 4, 0, 2*Math.PI);
    ctx.fillStyle = 'white';
    ctx.fill();
    ctx.beginPath();
    ctx.arc(-8, -7, 1.6, 0, 2*Math.PI);
    ctx.arc(8, -7, 1.6, 0, 2*Math.PI);
    ctx.fillStyle = 'black';
    ctx.fill();
    // Smile
    ctx.beginPath();
    ctx.arc(0, 3, 10, Math.PI*0.12, Math.PI*0.88);
    ctx.strokeStyle = 'hsl(33 60% 30%)';
    ctx.lineWidth = 1.6;
    ctx.stroke();
    // Limbs (static)
    ctx.lineWidth = 2.1;
    ctx.strokeStyle = 'hsl(36 60% 40%)';
    // Arms
    ctx.beginPath();
    ctx.moveTo(-COINBOY_WIDTH/2+7, 0);
    ctx.lineTo(-COINBOY_WIDTH/2+1, 16);
    ctx.moveTo(COINBOY_WIDTH/2-7, 0);
    ctx.lineTo(COINBOY_WIDTH/2-1, 16);
    ctx.stroke();
    // Legs
    ctx.beginPath();
    ctx.moveTo(-12, COINBOY_HEIGHT/2-10);
    ctx.lineTo(-14, COINBOY_HEIGHT/2-1);
    ctx.moveTo(12, COINBOY_HEIGHT/2-10);
    ctx.lineTo(14, COINBOY_HEIGHT/2-1);
    ctx.stroke();
    ctx.restore();
    return c;
};

// --- Coop/Player asset loading ---
const playerProceduralFallback = () => {
    // fallback: simple blue ellipse
    const { PLAYER_WIDTH, PLAYER_HEIGHT } = window.constants;
    const c = document.createElement('canvas');
    c.width = PLAYER_WIDTH;
    c.height = PLAYER_HEIGHT;
    const ctx = c.getContext('2d');
    ctx.save();
    ctx.translate(PLAYER_WIDTH/2, PLAYER_HEIGHT/2);
    ctx.fillStyle = 'blue';
    ctx.beginPath();
    ctx.ellipse(0, 0, PLAYER_WIDTH/2-7, PLAYER_HEIGHT/2-6, 0, 0, 2*Math.PI);
    ctx.fill();
    ctx.restore();
    return c;
};

const doomShroomProceduralFallback = () => {
    // fallback: purple mushroom with green spots
    const W = 54, H = 66;
    const c = document.createElement('canvas');
    c.width = W; c.height = H;
    const ctx = c.getContext('2d');
    ctx.save();
    ctx.translate(W/2, H/2);
    // Cap
    ctx.beginPath();
    ctx.ellipse(0, -10, 25, 18, 0, Math.PI, 2*Math.PI);
    ctx.closePath();
    ctx.fillStyle = 'purple';
    ctx.shadowColor = '#a0f';
    ctx.shadowBlur = 6;
    ctx.fill();
    ctx.shadowBlur = 0;
    // Spots
    ctx.beginPath();
    ctx.arc(-10, -16, 4, 0, 2*Math.PI);
    ctx.arc(7, -12, 3, 0, 2*Math.PI);
    ctx.arc(0, -8, 2.5, 0, 2*Math.PI);
    ctx.fillStyle = 'lime';
    ctx.fill();
    // Stem
    ctx.beginPath();
    ctx.ellipse(0, 14, 9, 20, 0, 0, 2*Math.PI);
    ctx.fillStyle = '#e0e0b0';
    ctx.fill();
    // Eyes
    ctx.beginPath();
    ctx.arc(-4, 8, 2, 0, 2*Math.PI);
    ctx.arc(4, 8, 2, 0, 2*Math.PI);
    ctx.fillStyle = '#222';
    ctx.fill();
    ctx.restore();
    return c;
};

const AssetLoader = {
    assets: {
        coinboyWalkFrames: [],
        coinboyRollFrames: [],
        playerWalkLeftFrames: [],
        playerWalkRightFrames: [],
        playerJumpFrames: [],
        playerAttackFramesLeft: [],
        playerAttackFramesRight: [],
        sideScrollerBGs: [],
        doomShroomWalkFrames: [],
        doomShroomHealFrames: []
    },
    loadAssets: async function() {
        const { loadImageWithFallback } = window.utils;
        // Coinboy assets (unchanged)
        this.assets.coinboyWalkFrames = await Promise.all(
            coinboyWalkFramesSrc.map(src => loadImageWithFallback(src, coinboyProceduralFallback))
        );
        // Roll frames: rotated by 45deg per frame
        this.assets.coinboyRollFrames = this.assets.coinboyWalkFrames.map((img, idx) => {
            // Create offscreen canvas, rotate
            const { COINBOY_WIDTH, COINBOY_HEIGHT } = window.constants;
            const c = document.createElement('canvas');
            c.width = COINBOY_WIDTH;
            c.height = COINBOY_HEIGHT;
            const ctx = c.getContext('2d');
            ctx.save();
            ctx.translate(COINBOY_WIDTH/2, COINBOY_HEIGHT/2);
            ctx.rotate((idx * Math.PI/4) / 2); // 0, 22.5, 45, ...
            ctx.drawImage(img, -COINBOY_WIDTH/2, -COINBOY_HEIGHT/2, COINBOY_WIDTH, COINBOY_HEIGHT);
            ctx.restore();
            return c;
        });

        // --- Player/Coop assets ---
        // Walk left frames
        this.assets.playerWalkLeftFrames = await Promise.all(
            coopWalkLeftUrls.map(src => loadImageWithFallback(src, playerProceduralFallback))
        );
        // Walk right frames: mirror walk left
        this.assets.playerWalkRightFrames = this.assets.playerWalkLeftFrames.map(img => {
            const { PLAYER_WIDTH, PLAYER_HEIGHT } = window.constants;
            const c = document.createElement('canvas');
            c.width = PLAYER_WIDTH;
            c.height = PLAYER_HEIGHT;
            const ctx = c.getContext('2d');
            ctx.save();
            ctx.translate(PLAYER_WIDTH/2, PLAYER_HEIGHT/2);
            ctx.scale(-1, 1);
            ctx.drawImage(img, -PLAYER_WIDTH/2, -PLAYER_HEIGHT/2, PLAYER_WIDTH, PLAYER_HEIGHT);
            ctx.restore();
            return c;
        });
        // Jump frames
        this.assets.playerJumpFrames = await Promise.all(
            coopJumpUrls.map(src => loadImageWithFallback(src, playerProceduralFallback))
        );
        // Attack frames - make them bigger than walk frames
        // We'll scale attack frames to 1.6x PLAYER_WIDTH and 1.6x PLAYER_HEIGHT, but keep the player's collision box the same
        // LEFT-facing attack frames (original)
        this.assets.playerAttackFramesLeft = await Promise.all(
            coopAttackUrls.map(async (src) => {
                // Load the image (or fallback)
                const img = await loadImageWithFallback(src, playerProceduralFallback);
                // Draw onto a canvas of bigger size
                const { PLAYER_WIDTH, PLAYER_HEIGHT } = window.constants;
                const scale = 1.6;
                const bigW = Math.round(PLAYER_WIDTH * scale);
                const bigH = Math.round(PLAYER_HEIGHT * scale);
                const c = document.createElement('canvas');
                c.width = bigW;
                c.height = bigH;
                const ctx = c.getContext('2d');
                ctx.save();
                ctx.drawImage(img, 0, 0, bigW, bigH);
                ctx.restore();
                return c;
            })
        );
        // RIGHT-facing attack frames (do NOT pre-mirror; mirroring now handled at render time)
        this.assets.playerAttackFramesRight = this.assets.playerAttackFramesLeft;

        // --- DoomShroom assets ---
        // Walk frames
        this.assets.doomShroomWalkFrames = await Promise.all(
            doomShroomWalkUrls.map(src => loadImageWithFallback(src, doomShroomProceduralFallback))
        );
        // Heal animation: produce a sequence that alternates left/right
        // We'll use 4 frames: [heal, heal-mirrored, heal, heal-mirrored]
        const healImg = await loadImageWithFallback(doomShroomHealUrl, doomShroomProceduralFallback);
        const DS_W = 54, DS_H = 66;
        const healFrames = [];
        for (let i = 0; i < 4; ++i) {
            const c = document.createElement('canvas');
            c.width = DS_W;
            c.height = DS_H;
            const ctx = c.getContext('2d');
            ctx.save();
            ctx.translate(DS_W/2, DS_H/2);
            if (i % 2 === 1) ctx.scale(-1, 1); // mirror every other
            ctx.drawImage(healImg, -DS_W/2, -DS_H/2, DS_W, DS_H);
            ctx.restore();
            healFrames.push(c);
        }
        this.assets.doomShroomHealFrames = healFrames;

        // --- Side-scroller backgrounds ---
        this.assets.sideScrollerBGs = await Promise.all(
            sideScrollerBGUrls.map(src => loadImageWithFallback(src, () => {
                // fallback: solid color
                const { GAME_WIDTH, GAME_HEIGHT } = window.constants;
                const c = document.createElement('canvas');
                c.width = GAME_WIDTH;
                c.height = GAME_HEIGHT;
                const ctx = c.getContext('2d');
                ctx.fillStyle = "#b0e0ff";
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                ctx.fillStyle = "#fff";
                ctx.font = "bold 48px sans-serif";
                ctx.fillText("Missing BG", 100, 100);
                return c;
            }))
        );
    },
    getCoinboyWalkFrames() {
        return this.assets.coinboyWalkFrames;
    },
    getCoinboyRollFrames() {
        return this.assets.coinboyRollFrames;
    },
    getPlayerWalkFrames(facing) {
        // facing: -1 = left, 1 = right
        return facing === -1 ? this.assets.playerWalkLeftFrames : this.assets.playerWalkRightFrames;
    },
    getPlayerJumpFrames(facing) {
        // For now, same for both directions, but could mirror if needed
        return this.assets.playerJumpFrames;
    },
    getPlayerAttackFrames(facing) {
        // facing: -1 = left, 1 = right
        // Now both use the same frames, mirroring is done at render time for right
        return this.assets.playerAttackFramesLeft;
    },
    getSideScrollerBGs() {
        return this.assets.sideScrollerBGs;
    },
    getDoomShroomWalkFrames() {
        return this.assets.doomShroomWalkFrames;
    },
    getDoomShroomHealFrames() {
        return this.assets.doomShroomHealFrames;
    }
};

window.AssetLoader = AssetLoader;